name: ğŸš€ Dayliz App CI/CD Pipeline

on:
  push:
    branches: [ main, production-readiness, staging ]
  pull_request:
    branches: [ main, production-readiness ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.5'
  JAVA_VERSION: '17'

jobs:
  # ğŸ” Security and Code Quality Checks
  security-scan:
    name: ğŸ”’ Security & Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ğŸ•µï¸ Secret Detection with GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Dependency Review
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'

  # ğŸ§ª Flutter Build and Test
  build-and-test:
    name: ğŸ—ï¸ Build & Test Flutter App
    runs-on: ubuntu-latest
    needs: security-scan
    strategy:
      matrix:
        environment: [development, staging]
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get Flutter Dependencies
        working-directory: apps/mobile
        run: flutter pub get

      - name: ğŸ” Analyze Flutter Code
        working-directory: apps/mobile
        run: flutter analyze --fatal-infos

      - name: ğŸ§ª Run Flutter Tests
        working-directory: apps/mobile
        run: flutter test --coverage

      - name: ğŸ“Š Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: apps/mobile/coverage/lcov.info
          flags: flutter
          name: flutter-coverage

      - name: ğŸ”§ Validate Environment Variables
        working-directory: apps/mobile
        run: |
          echo "Validating required environment variables..."
          if [ -z "$GOOGLE_MAPS_API_KEY" ]; then
            echo "âŒ GOOGLE_MAPS_API_KEY is required"
            exit 1
          fi
          echo "âœ… Environment validation passed"
        env:
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}

      - name: ğŸ—ï¸ Build APK (Debug)
        working-directory: apps/mobile
        run: flutter build apk --debug --target-platform android-arm64
        env:
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}

      - name: ğŸ“± Build APK (Release) - Production Only
        if: matrix.environment == 'staging' && github.ref == 'refs/heads/main'
        working-directory: apps/mobile
        run: flutter build apk --release --target-platform android-arm64
        env:
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY_PROD }}

      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.environment }}-${{ github.sha }}
          path: apps/mobile/build/app/outputs/flutter-apk/*.apk
          retention-days: 30

  # ğŸ”’ Security Testing
  security-testing:
    name: ğŸ›¡ï¸ Security Testing
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production-readiness'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” SAST with Semgrep
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: ğŸ“Š Upload SAST results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif

  # ğŸš€ Deployment (Staging) - DISABLED FOR NOW
  deploy-staging:
    name: ğŸš€ Deploy to Staging (Artifacts Only)
    runs-on: ubuntu-latest
    needs: [build-and-test, security-testing]
    if: github.ref == 'refs/heads/production-readiness' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: apk-staging-${{ github.sha }}

      - name: ğŸ“‹ Deployment Summary
        run: |
          echo "ğŸš€ Staging Deployment Summary"
          echo "================================"
          echo "âœ… Build artifacts ready for distribution"
          echo "ğŸ“± APK files available in GitHub Actions artifacts"
          echo "ğŸ”„ Firebase App Distribution: Not configured yet"
          echo ""
          echo "To enable Firebase deployment:"
          echo "1. Set up Firebase project"
          echo "2. Add FIREBASE_APP_ID_STAGING secret"
          echo "3. Add FIREBASE_SERVICE_ACCOUNT secret"
          echo "4. Uncomment Firebase deployment step"

          ls -la *.apk || echo "No APK files found"

      - name: ğŸš€ Deploy to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_STAGING }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          groups: testers
          file: app-debug.apk
          releaseNotes: |
            ğŸš€ Staging Build - ${{ github.sha }}

            Changes in this build:
            ${{ github.event.head_commit.message }}

            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}

  # ğŸ“Š Build Status Notification
  notify:
    name: ğŸ“¢ Build Notification
    runs-on: ubuntu-latest
    needs: [security-scan, build-and-test, security-testing]
    if: always()
    
    steps:
      - name: ğŸ“Š Build Status Summary
        run: |
          echo "ğŸ” Security Scan: ${{ needs.security-scan.result }}"
          echo "ğŸ—ï¸ Build & Test: ${{ needs.build-and-test.result }}"
          echo "ğŸ›¡ï¸ Security Testing: ${{ needs.security-testing.result }}"
          
          if [[ "${{ needs.security-scan.result }}" == "failure" || "${{ needs.build-and-test.result }}" == "failure" ]]; then
            echo "âŒ Pipeline failed - Check logs for details"
            exit 1
          else
            echo "âœ… Pipeline completed successfully"
          fi
