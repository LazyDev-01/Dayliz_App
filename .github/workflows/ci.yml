name: ğŸš€ Smart Selective CI/CD Pipeline

on:
  push:
    branches: [ main, production-readiness, staging ]
  pull_request:
    branches: [ main, production-readiness ]
  workflow_dispatch:
    inputs:
      force_all:
        description: 'Force deploy all apps'
        required: false
        default: 'false'
        type: boolean
      deploy_mobile:
        description: 'Deploy Mobile App to Production'
        required: false
        default: 'auto'
        type: choice
        options:
          - 'auto'
          - 'true'
          - 'false'
      deploy_agent:
        description: 'Deploy Agent App to Production'
        required: false
        default: 'auto'
        type: choice
        options:
          - 'auto'
          - 'true'
          - 'false'
      deploy_vendor:
        description: 'Deploy Vendor Panel to Production'
        required: false
        default: 'auto'
        type: choice
        options:
          - 'auto'
          - 'true'
          - 'false'
      deploy_admin:
        description: 'Deploy Admin Panel to Production'
        required: false
        default: 'auto'
        type: choice
        options:
          - 'auto'
          - 'true'
          - 'false'
      deploy_api:
        description: 'Deploy API Service to Production'
        required: false
        default: 'auto'
        type: choice
        options:
          - 'auto'
          - 'true'
          - 'false'

permissions:
  contents: read
  security-events: write
  actions: read
  checks: write

env:
  FLUTTER_VERSION: '3.29.2'
  JAVA_VERSION: '17'
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # ğŸ” Smart Change Detection
  detect-changes:
    name: ğŸ” Detect Changes
    uses: ./.github/workflows/detect-changes.yml

  # ğŸ”’ Security Scanning
  security-scan:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ›¡ï¸ Run Security Scan
        uses: ./.github/actions/security-scan
        with:
          scan-type: 'comprehensive'

  # ğŸ“± Mobile App Pipeline
  build-mobile:
    name: ğŸ“± Build Mobile App
    if: |
      (needs.detect-changes.outputs.mobile == 'true' && github.event.inputs.deploy_mobile != 'false') ||
      needs.detect-changes.outputs.force_all == 'true' ||
      github.event.inputs.deploy_mobile == 'true'
    uses: ./.github/workflows/mobile-ci.yml
    needs: [detect-changes, security-scan]
    secrets: inherit

  # ğŸšš Agent App Pipeline
  build-agent:
    name: ğŸšš Build Agent App
    if: |
      (needs.detect-changes.outputs.agent == 'true' && github.event.inputs.deploy_agent != 'false') ||
      needs.detect-changes.outputs.force_all == 'true' ||
      github.event.inputs.deploy_agent == 'true'
    uses: ./.github/workflows/agent-ci.yml
    needs: [detect-changes, security-scan]
    secrets: inherit

  # ğŸª Vendor Panel Pipeline
  build-vendor:
    name: ğŸª Build Vendor Panel
    if: |
      (needs.detect-changes.outputs.vendor == 'true' && github.event.inputs.deploy_vendor != 'false') ||
      needs.detect-changes.outputs.force_all == 'true' ||
      github.event.inputs.deploy_vendor == 'true'
    uses: ./.github/workflows/vendor-ci.yml
    needs: [detect-changes, security-scan]
    secrets: inherit

  # âš™ï¸ Admin Panel Pipeline
  build-admin:
    name: âš™ï¸ Build Admin Panel
    if: |
      (needs.detect-changes.outputs.admin == 'true' && github.event.inputs.deploy_admin != 'false') ||
      needs.detect-changes.outputs.force_all == 'true' ||
      github.event.inputs.deploy_admin == 'true'
    uses: ./.github/workflows/admin-ci.yml
    needs: [detect-changes, security-scan]
    secrets: inherit

  # ğŸ”§ API Service Pipeline
  build-api:
    name: ğŸ”§ Build API Service
    if: |
      (needs.detect-changes.outputs.api == 'true' && github.event.inputs.deploy_api != 'false') ||
      needs.detect-changes.outputs.force_all == 'true' ||
      github.event.inputs.deploy_api == 'true'
    uses: ./.github/workflows/api-ci.yml
    needs: [detect-changes, security-scan]
    secrets: inherit

  # ğŸ“š Documentation Pipeline
  build-docs:
    name: ğŸ“š Build Documentation
    if: needs.detect-changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    needs: [detect-changes]
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“š Deploy Documentation
        run: |
          echo "ğŸ“š Documentation updated - deploying to GitHub Pages"
          echo "âœ… Documentation deployment complete"

  # ğŸ“Š Build Summary & Notifications
  notify:
    name: ğŸ“Š Build Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, security-scan, build-mobile, build-agent, build-vendor, build-admin, build-api, build-docs]
    if: always()

    steps:
      - name: ğŸ“Š Smart CI/CD Pipeline Summary
        run: |
          echo "ğŸš€ Smart Selective CI/CD Pipeline Complete!"
          echo "============================================="
          echo ""
          echo "ğŸ” Change Detection Results:"
          echo "ğŸ“± Mobile App: ${{ needs.detect-changes.outputs.mobile }}"
          echo "ğŸšš Agent App: ${{ needs.detect-changes.outputs.agent }}"
          echo "ğŸª Vendor Panel: ${{ needs.detect-changes.outputs.vendor }}"
          echo "âš™ï¸ Admin Panel: ${{ needs.detect-changes.outputs.admin }}"
          echo "ğŸ”§ API Service: ${{ needs.detect-changes.outputs.api }}"
          echo "ğŸ“¦ Packages: ${{ needs.detect-changes.outputs.packages }}"
          echo "ğŸ“š Documentation: ${{ needs.detect-changes.outputs.docs }}"
          echo "ğŸ› ï¸ Infrastructure: ${{ needs.detect-changes.outputs.infrastructure }}"
          echo "ğŸš€ Force All: ${{ needs.detect-changes.outputs.force_all }}"
          echo ""
          echo "ğŸ“Š Build Results:"
          echo "ğŸ”’ Security Scan: ${{ needs.security-scan.result }}"
          echo "ğŸ“± Mobile Build: ${{ needs.build-mobile.result || 'skipped' }}"
          echo "ğŸšš Agent Build: ${{ needs.build-agent.result || 'skipped' }}"
          echo "ğŸª Vendor Build: ${{ needs.build-vendor.result || 'skipped' }}"
          echo "âš™ï¸ Admin Build: ${{ needs.build-admin.result || 'skipped' }}"
          echo "ğŸ”§ API Build: ${{ needs.build-api.result || 'skipped' }}"
          echo "ğŸ“š Docs Build: ${{ needs.build-docs.result || 'skipped' }}"
          echo ""

          # Calculate deployment efficiency
          TOTAL_APPS=5
          DEPLOYED_APPS=0

          if [[ "${{ needs.build-mobile.result }}" == "success" ]]; then
            DEPLOYED_APPS=$((DEPLOYED_APPS + 1))
          fi
          if [[ "${{ needs.build-agent.result }}" == "success" ]]; then
            DEPLOYED_APPS=$((DEPLOYED_APPS + 1))
          fi
          if [[ "${{ needs.build-vendor.result }}" == "success" ]]; then
            DEPLOYED_APPS=$((DEPLOYED_APPS + 1))
          fi
          if [[ "${{ needs.build-admin.result }}" == "success" ]]; then
            DEPLOYED_APPS=$((DEPLOYED_APPS + 1))
          fi
          if [[ "${{ needs.build-api.result }}" == "success" ]]; then
            DEPLOYED_APPS=$((DEPLOYED_APPS + 1))
          fi

          if [[ $DEPLOYED_APPS -eq 0 ]]; then
            echo "âœ… Optimal: No app deployments needed"
            EFFICIENCY="100%"
          else
            EFFICIENCY=$((100 - (DEPLOYED_APPS * 100 / TOTAL_APPS)))
            echo "ğŸ“Š Deployment Efficiency: $EFFICIENCY% (deployed $DEPLOYED_APPS/$TOTAL_APPS apps)"
          fi

          # Check for failures
          failed_jobs=""
          if [[ "${{ needs.security-scan.result }}" == "failure" ]]; then
            failed_jobs="$failed_jobs Security-Scan"
          fi
          if [[ "${{ needs.build-mobile.result }}" == "failure" ]]; then
            failed_jobs="$failed_jobs Mobile-Build"
          fi
          if [[ "${{ needs.build-agent.result }}" == "failure" ]]; then
            failed_jobs="$failed_jobs Agent-Build"
          fi
          if [[ "${{ needs.build-vendor.result }}" == "failure" ]]; then
            failed_jobs="$failed_jobs Vendor-Build"
          fi
          if [[ "${{ needs.build-admin.result }}" == "failure" ]]; then
            failed_jobs="$failed_jobs Admin-Build"
          fi
          if [[ "${{ needs.build-api.result }}" == "failure" ]]; then
            failed_jobs="$failed_jobs API-Build"
          fi

          if [ -n "$failed_jobs" ]; then
            echo ""
            echo "âŒ Pipeline failed in: $failed_jobs"
            echo "ğŸ” Check the failed job logs for detailed error information"
            exit 1
          else
            echo ""
            echo "âœ… All pipeline stages completed successfully!"
            echo "ğŸ‰ Smart selective deployment achieved $EFFICIENCY efficiency"
          fi
