name: ğŸ“± Mobile App CI/CD

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'development'
        type: string
      skip_tests:
        description: 'Skip tests for faster builds'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  actions: read
  checks: write

env:
  FLUTTER_VERSION: '3.29.2'
  JAVA_VERSION: '17'

jobs:
  build-mobile:
    name: ğŸ“± Build Mobile App
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [development, staging]
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter Environment
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache-key-suffix: mobile-${{ matrix.environment }}

      - name: ğŸ“¦ Install Dependencies
        working-directory: apps/mobile
        run: |
          echo "ğŸ“¦ Installing mobile app dependencies..."
          
          # Enhanced dependency resolution with retries
          for attempt in 1 2 3; do
            echo "ğŸ”„ Dependency resolution attempt $attempt/3..."
            
            if flutter pub get --verbose; then
              echo "âœ… Dependencies resolved successfully on attempt $attempt"
              break
            else
              if [ $attempt -eq 3 ]; then
                echo "ğŸ’¥ Dependency resolution failed after 3 attempts"
                flutter doctor -v
                exit 1
              fi
              echo "â³ Waiting 5 seconds before retry..."
              sleep 5
            fi
          done
          
          # Verify dependencies
          flutter pub deps --style=compact
          echo "âœ… Mobile app dependencies installed successfully"

      - name: ğŸ” Code Analysis
        working-directory: apps/mobile
        run: |
          echo "ğŸ” Running Flutter code analysis for mobile app..."
          
          # Run analysis and capture results
          flutter analyze --verbose > analysis_output.txt 2>&1 || true
          
          # Count different types of issues
          ERROR_COUNT=$(grep -c "error -" analysis_output.txt || echo "0")
          WARNING_COUNT=$(grep -c "warning -" analysis_output.txt || echo "0")
          INFO_COUNT=$(grep -c "info -" analysis_output.txt || echo "0")
          
          echo "ğŸ“Š Mobile App Analysis Results:"
          echo "  ğŸ”´ Errors: $ERROR_COUNT"
          echo "  ğŸŸ¡ Warnings: $WARNING_COUNT"
          echo "  ğŸ”µ Info: $INFO_COUNT"
          
          # Check for critical errors in main source code
          MAIN_ERRORS=$(grep "error -" analysis_output.txt | grep -v "test/" | wc -l || echo "0")
          
          if [ "$MAIN_ERRORS" -gt "0" ]; then
            echo "âŒ Critical errors found in mobile app source code:"
            grep "error -" analysis_output.txt | grep -v "test/" | head -10
            echo "ğŸ’¡ Fix these errors before proceeding"
            exit 1
          else
            echo "âœ… Mobile app code analysis passed"
          fi
          
          # Clean up
          rm -f analysis_output.txt

      - name: ğŸ§ª Run Tests
        if: inputs.skip_tests != true
        working-directory: apps/mobile
        run: |
          echo "ğŸ§ª Running mobile app tests..."
          
          if flutter test --coverage --verbose; then
            echo "âœ… All mobile app tests passed"
          else
            echo "âŒ Some mobile app tests failed"
            echo "âš ï¸ Test failures should be addressed before production deployment"
            # Don't fail the build for test failures in development
            if [[ "${{ matrix.environment }}" == "staging" ]]; then
              exit 1
            fi
          fi

      - name: ğŸ“Š Upload Test Coverage
        if: inputs.skip_tests != true
        uses: codecov/codecov-action@v5
        continue-on-error: true
        with:
          file: apps/mobile/coverage/lcov.info
          flags: mobile-app
          name: mobile-coverage-${{ matrix.environment }}

      - name: ğŸ”§ Environment Setup
        working-directory: apps/mobile
        run: |
          echo "ğŸ”§ Setting up mobile app environment for ${{ matrix.environment }}..."
          
          # Create environment-specific configuration
          if [ ! -f ".env" ]; then
            echo "âš ï¸ .env file not found, creating minimal version..."
            echo "# Mobile app environment configuration" > .env
            echo "ENVIRONMENT=${{ matrix.environment }}" >> .env
          fi
          
          # Validate environment variables
          if [ -n "$GOOGLE_MAPS_API_KEY" ]; then
            echo "âœ… GOOGLE_MAPS_API_KEY is configured"
          else
            echo "âš ï¸ GOOGLE_MAPS_API_KEY not set - using placeholder for CI"
            export GOOGLE_MAPS_API_KEY="CI_PLACEHOLDER_KEY"
          fi
          
          echo "âœ… Mobile app environment setup completed"
        env:
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}

      - name: ğŸ—ï¸ Build Debug APK
        working-directory: apps/mobile
        run: |
          echo "ğŸ—ï¸ Building mobile app debug APK..."
          
          # Set environment variables
          export GOOGLE_MAPS_API_KEY="${GOOGLE_MAPS_API_KEY:-CI_PLACEHOLDER_KEY}"
          
          if flutter build apk --debug --target-platform android-arm64 --verbose; then
            echo "âœ… Mobile app debug APK built successfully"
            ls -la build/app/outputs/flutter-apk/
            
            # Get APK size
            APK_SIZE=$(stat -c%s "build/app/outputs/flutter-apk/app-debug.apk" 2>/dev/null || echo "0")
            APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1024 / 1024" | bc -l 2>/dev/null || echo "0")
            echo "ğŸ“± Mobile APK Size: ${APK_SIZE_MB} MB"
          else
            echo "âŒ Mobile app debug APK build failed"
            flutter doctor -v
            exit 1
          fi
        env:
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}

      - name: ğŸ“± Build Release APK
        if: matrix.environment == 'staging' && github.ref == 'refs/heads/production-readiness'
        working-directory: apps/mobile
        run: |
          echo "ğŸ“± Building mobile app release APK..."
          
          # Validate production environment
          if [ -z "$GOOGLE_MAPS_API_KEY_PROD" ]; then
            echo "âŒ GOOGLE_MAPS_API_KEY_PROD is required for production builds"
            exit 1
          fi
          
          if flutter build apk --release --target-platform android-arm64 --verbose; then
            echo "âœ… Mobile app release APK built successfully"
            ls -la build/app/outputs/flutter-apk/
          else
            echo "âŒ Mobile app release APK build failed"
            exit 1
          fi
        env:
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY_PROD }}

      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mobile-apk-${{ matrix.environment }}-${{ github.sha }}
          path: |
            apps/mobile/build/app/outputs/flutter-apk/*.apk
            apps/mobile/coverage/lcov.info
          retention-days: 30

      - name: ğŸš€ Deploy to Firebase App Distribution
        if: matrix.environment == 'staging' && github.ref == 'refs/heads/production-readiness'
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        continue-on-error: true
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_MOBILE }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          groups: mobile-testers
          file: apps/mobile/build/app/outputs/flutter-apk/app-debug.apk
          releaseNotes: |
            ğŸš€ Mobile App Build - ${{ github.sha }}
            
            ğŸ“ Changes in this build:
            ${{ github.event.head_commit.message }}
            
            ğŸ“Š Build Information:
            â€¢ Environment: ${{ matrix.environment }}
            â€¢ Branch: ${{ github.ref_name }}
            â€¢ Commit: ${{ github.sha }}
            â€¢ Build Date: ${{ github.event.head_commit.timestamp }}

      - name: ğŸ“Š Build Summary
        run: |
          echo "ğŸ“Š Mobile App Build Summary"
          echo "==========================="
          echo "ğŸ“± App: Mobile Customer App"
          echo "ğŸ—ï¸ Environment: ${{ matrix.environment }}"
          echo "âœ… Build Status: Success"
          echo "ğŸ“¦ Artifacts: Uploaded to GitHub Actions"
          if [[ "${{ matrix.environment }}" == "staging" ]]; then
            echo "ğŸš€ Deployment: Firebase App Distribution"
          fi
          echo "ğŸ‰ Mobile app pipeline completed successfully!"
